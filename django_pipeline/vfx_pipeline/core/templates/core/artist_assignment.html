{% extends 'core/base.html' %}

{% block title %}Artist Assignment{% endblock %}

{% block content %}
<style>
  .assignment-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: 2.5rem;
    align-items: flex-start;
  }

  .assignment-wrapper .panel {
    background: linear-gradient(135deg, #2d2d33 0%, #242429 100%);
    border-radius: 14px;
    padding: 24px;
    box-shadow: 0 14px 24px rgba(0, 0, 0, 0.35);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .form-panel {
    flex: 1 1 320px;
    max-width: 420px;
  }

  .roster-panel {
    flex: 1 1 640px;
    min-width: 0;
    overflow-x: auto;
  }

  .form-panel h2,
  .roster-panel h2 {
    margin: 0 0 18px;
    font-size: 1.5rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    color: #fdfdfd;
  }

  .add-task-form {
    display: grid;
    gap: 16px;
  }

  .add-task-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .add-task-form label {
    font-weight: 600;
    color: #d9d9e3;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.06em;
  }

  .add-task-form select,
  .add-task-form textarea,
  .add-task-form input[type="text"] {
    background: rgba(20, 20, 26, 0.85);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    padding: 10px 12px;
    color: #f5f5f5;
    font-size: 0.95rem;
    transition: border 0.2s ease, box-shadow 0.2s ease;
  }

  .add-task-form textarea {
    min-height: 48px;
    resize: vertical;
  }

  .add-task-form select:focus,
  .add-task-form textarea:focus,
  .add-task-form input[type="text"]:focus {
    border-color: #5bc0de;
    box-shadow: 0 0 0 3px rgba(91, 192, 222, 0.25);
    outline: none;
  }

  .filter-form {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .filter-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 160px;
    margin: 0;
  }

  .filter-form label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #b9bed0;
    font-weight: 600;
  }

  .filter-form select {
    background: rgba(20, 20, 26, 0.85);
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    padding: 8px 14px;
    color: #f5f5f5;
  }

  .assignment-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: rgba(36, 36, 42, 0.95);
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.06);
  }

  .assignment-table th,
  .assignment-table td {
    padding: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    vertical-align: top;
    color: #f6f6fb;
    font-size: 0.92rem;
  }

  .assignment-table th {
    background: rgba(17, 17, 22, 0.92);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: 0.75rem;
  }

  .assignment-table tbody tr:hover {
    background: rgba(91, 192, 222, 0.12);
  }

  .assignment-table .artist-header {
    background: linear-gradient(135deg, rgba(91, 192, 222, 0.22) 0%, rgba(42, 42, 48, 0.9) 100%);
    cursor: pointer;
    font-weight: 600;
    letter-spacing: 0.04em;
  }

  .assignment-table .artist-header:hover {
    background: rgba(91, 192, 222, 0.35);
  }

  .assignment-table .toggle-icon {
    margin-right: 0.5rem;
    font-weight: 700;
    color: #5bc0de;
  }

  .assignment-table .task-row {
    background: rgba(36, 36, 42, 0.95);
  }

  .assignment-table .task-row.green {
    background: rgba(34, 124, 58, 0.16);
  }

  .assignment-table .task-row.orange {
    background: rgba(138, 98, 36, 0.18);
  }

  .assignment-table input[type="text"],
  .assignment-table textarea,
  .assignment-table select {
    width: 100%;
    background: rgba(20, 20, 26, 0.85);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    padding: 8px 10px;
    color: #f5f5f5;
    font-size: 0.9rem;
  }

  .assignment-table textarea {
    resize: vertical;
  }

  .assignment-table select:focus,
  .assignment-table textarea:focus,
  .assignment-table input[type="text"]:focus {
    border-color: #5bc0de;
    box-shadow: 0 0 0 3px rgba(91, 192, 222, 0.25);
    outline: none;
  }

  .status-select {
    background: rgba(18, 18, 24, 0.95);
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    padding: 6px 26px 6px 12px;
    color: #f5f5f5;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: border 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }

  .status-select:focus {
    border-color: #5bc0de;
    box-shadow: 0 0 0 3px rgba(91, 192, 222, 0.25);
    outline: none;
  }

  .status-select.status-not_started {
    background: rgba(80, 80, 98, 0.85);
    border-color: rgba(80, 80, 98, 0.95);
  }

  .status-select.status-wip {
    background: rgba(63, 98, 138, 0.78);
    border-color: rgba(63, 98, 138, 0.95);
  }

  .status-select.status-internal_approved,
  .status-select.status-client_approved,
  .status-select.status-done {
    background: rgba(34, 124, 58, 0.75);
    border-color: rgba(34, 124, 58, 0.9);
  }

  .status-select option,
  .status-select optgroup {
    background: #1a1a23;
    color: #f5f5f5;
  }

  .actions-cell {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .inline-form {
    display: inline-flex;
    gap: 0.25rem;
    align-items: center;
    margin: 0;
  }

  .inline-form .btn {
    border-radius: 999px;
    padding: 8px 16px;
  }
</style>

<h1>Artist Assignment</h1>

<div class="assignment-wrapper">
  <!-- Left column: forms -->
  <div class="panel form-panel">
    <h2>Assign Task</h2>
    <form method="post" class="add-task-form">
      {% csrf_token %}

      <div class="form-group">
        <label for="id_artist">Artist</label>
        {{ task_form.artist }}
      </div>

      <div class="form-group">
        <label for="assign_type">Assign To</label>
        <select id="assign_type" class="assignment-select">
          <option value="">-- Select --</option>
          <option value="asset">Asset</option>
          <option value="shot">Shot</option>
        </select>
      </div>

      <div class="form-group asset-field" style="display:none;">
        <label for="id_asset">Asset</label>
        {{ task_form.asset }}
      </div>

      <div class="form-group sequence-field" style="display:none;">
        <label for="id_sequence">Sequence</label>
        {{ task_form.sequence }}
      </div>

      <div class="form-group shot-field" style="display:none;">
        <label for="id_shot">Shot</label>
        {{ task_form.shot }}
      </div>

      <div class="form-group task-name-field" style="display:none;">
        <label for="id_task_name">Task Name</label>
        {{ task_form.task_name }}
      </div>

      <div class="form-group">
        <label for="id_task_type">Department</label>
        {{ task_form.task_type }}
      </div>

      <div class="form-group">
        <label for="id_description">Description</label>
        {{ task_form.description }}
      </div>

      <div class="form-group">
        <label for="id_status">Status</label>
        {{ task_form.status }}
      </div>

      <input type="hidden" name="filter_project" value="{{ filter_project }}">
      <input type="hidden" name="filter_sequence" value="{{ filter_sequence }}">
      <input type="hidden" name="filter_shot" value="{{ filter_shot }}">
      <input type="hidden" name="filter_asset" value="{{ filter_asset }}">
      <input type="hidden" name="filter_context" value="{{ filter_context }}">
      <input type="hidden" name="open_artists" id="open_artists_left">
      <input type="hidden" name="open_artists" id="open_artists_right">
      <button type="submit" name="add_task" class="btn btn-secondary">Add Task</button>
    </form>
  </div>

  <!-- Right column: tasks grouped by artist -->
  <div class="panel roster-panel">
    <h2>Artists &amp; Tasks</h2>

    <form method="get" class="filter-form" id="task-filter-form">
      <input type="hidden" name="open" id="open_artists_filter" class="open-artists-input">
      <div class="form-group">
        <label for="filter_context">Context</label>
        <select id="filter_context" name="context" class="filter-select">
          <option value="" {% if not filter_context %}selected{% endif %}>---</option>
          <option value="shot" {% if filter_context == 'shot' %}selected{% endif %}>Shots</option>
          <option value="asset" {% if filter_context == 'asset' %}selected{% endif %}>Assets</option>
        </select>
      </div>
      <div class="form-group">
        <label for="filter_project">Project</label>
        <select id="filter_project" name="project" class="filter-select">
          <option value="">----</option>
          {% for project in project_options %}
            <option value="{{ project.id }}" {% if filter_project == project.id|stringformat:"s" %}selected{% endif %}>{{ project.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group asset-filter-group" {% if filter_context != 'asset' %}style="display:none;"{% endif %}>
        <label for="filter_asset">Asset</label>
        <select id="filter_asset" name="asset" data-selected="{{ filter_asset }}" class="filter-select"{% if filter_context != 'asset' or not filter_project %} disabled{% endif %}>
          <option value="">----</option>
        </select>
      </div>
      <div class="form-group sequence-filter-group" {% if filter_context == 'asset' %}style="display:none;"{% endif %}>
        <label for="filter_sequence">Sequence</label>
        <select id="filter_sequence" name="sequence" data-selected="{{ filter_sequence }}" class="filter-select"{% if filter_context == 'asset' or not filter_project %} disabled{% endif %}>
          <option value="">----</option>
        </select>
      </div>
      <div class="form-group shot-filter-group" {% if filter_context == 'asset' %}style="display:none;"{% endif %}>
        <label for="filter_shot">Shot</label>
        <select id="filter_shot" name="shot" data-selected="{{ filter_shot }}" class="filter-select"{% if filter_context == 'asset' or not filter_sequence %} disabled{% endif %}>
          <option value="">----</option>
        </select>
      </div>
    </form>

    <table class="assignment-table">
      <thead>
        <tr>
          <th>Project</th>
          <th>Asset</th>
          <th>Sequence / Shot</th>
          <th>Task</th>
          <th>Department</th>
          <th>Description</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for artist in artists %}
          <tr class="artist-header" data-artist="{{ artist.id }}">
            <td colspan="8">
              <span class="toggle-icon">+</span>
              <strong>{{ artist.username }}</strong>
            </td>
          </tr>
          {% for task in artist.tasks.all %}
            <tr class="task-row artist-{{ artist.id }} green" style="display:none;">
              <td>
                {% if task.asset %}
                  {{ task.asset.project.name }}
                {% elif task.sequence %}
                  {{ task.sequence.project.name }}
                {% elif task.shot %}
                  {{ task.shot.sequence.project.name }}
                {% else %}-{% endif %}
              </td>
              <td>{% if task.asset %}{{ task.asset.name }}{% else %}-{% endif %}</td>
              <td>
                {% if task.sequence and task.shot %}
                  {{ task.sequence.name }}_{{ task.shot.name }}
                {% elif task.sequence %}
                  {{ task.sequence.name }}
                {% elif task.shot %}
                  {{ task.shot.name }}
                {% else %}-{% endif %}
              </td>
              <td>
                <input type="text" name="task_name" form="update-task-{{ task.id }}" value="{{ task.task_name|default_if_none:'' }}" />
              </td>
              <td>
                <select name="task_type" form="update-task-{{ task.id }}">
                  {% for value,label in department_choices %}
                    <option value="{{ value }}" {% if task.task_type == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <textarea name="description" form="update-task-{{ task.id }}" rows="2">{{ task.description|default_if_none:'' }}</textarea>
              </td>
              <td>
                <select name="status" form="update-task-{{ task.id }}" class="status-select status-{{ task.status }}">
                  {% for code,label in task.STATUS_CHOICES %}
                    <option value="{{ code }}" {% if code == task.status %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="actions-cell">
                <form id="update-task-{{ task.id }}" action="{% url 'update_task' task.id %}" method="post" class="inline-form">
                  {% csrf_token %}
                  <input type="hidden" name="filter_project" value="{{ filter_project }}">
                  <input type="hidden" name="filter_sequence" value="{{ filter_sequence }}">
                  <input type="hidden" name="filter_shot" value="{{ filter_shot }}">
                  <input type="hidden" name="filter_asset" value="{{ filter_asset }}">
                  <input type="hidden" name="filter_context" value="{{ filter_context }}">
                  <input type="hidden" name="open_artists" class="open-artists-input">
                  <button type="submit" class="btn btn-secondary">Update</button>
                </form>
                <form action="{% url 'delete_task' task.id %}" method="post" class="inline-form">
                  {% csrf_token %}
                  <input type="hidden" name="filter_project" value="{{ filter_project }}">
                  <input type="hidden" name="filter_sequence" value="{{ filter_sequence }}">
                  <input type="hidden" name="filter_shot" value="{{ filter_shot }}">
                  <input type="hidden" name="filter_asset" value="{{ filter_asset }}">
                  <input type="hidden" name="filter_context" value="{{ filter_context }}">
                  <input type="hidden" name="open_artists" class="open-artists-input">
                  <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this task?');">
                    Delete
                  </button>
                </form>
              </td>
            </tr>
          {% empty %}
            <tr class="task-row artist-{{ artist.id }} green" style="display:none;">
              <td colspan="8">No tasks assigned</td>
            </tr>
          {% endfor %}
        {% empty %}
          <tr>
            <td colspan="8">{% if filters_active %}No tasks match the current filters.{% else %}No artists yet.{% endif %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script type="application/json" id="project-sequence-data">{{ project_sequence_json|safe }}</script>
<script type="application/json" id="project-asset-data">{{ project_asset_json|safe }}</script>
<script type="application/json" id="sequence-shot-data">{{ sequence_shot_json|safe }}</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const openArtists = new Set();

    const syncOpenInputs = () => {
      const value = Array.from(openArtists).join(',');
      document.querySelectorAll('#open_artists_left, #open_artists_right, .open-artists-input')
        .forEach(input => { input.value = value; });
    };

    document.querySelectorAll('.artist-header').forEach(header => {
      header.addEventListener('click', () => {
        const artistId = header.getAttribute('data-artist');
        const icon = header.querySelector('.toggle-icon');
        const rows = document.querySelectorAll('.artist-' + artistId);
        const isHidden = [...rows].every(row => row.style.display === 'none');
        rows.forEach(row => { row.style.display = isHidden ? 'table-row' : 'none'; });
        icon.textContent = isHidden ? '-' : '+';
        if (isHidden) {
          openArtists.add(artistId);
        } else {
          openArtists.delete(artistId);
        }
        syncOpenInputs();
      });
    });

    const params = new URLSearchParams(window.location.search);
    const open = params.get('open');
    if (open) {
      open.split(',').forEach(id => {
        document.querySelectorAll('.artist-' + id)
          .forEach(row => { row.style.display = 'table-row'; });
        const icon = document.querySelector('.artist-header[data-artist="' + id + '"] .toggle-icon');
        if (icon) {
          icon.textContent = '-';
        }
        openArtists.add(id);
      });
      syncOpenInputs();
    }

    const projectSequenceElement = document.getElementById('project-sequence-data');
    const projectSequenceData = projectSequenceElement ? JSON.parse(projectSequenceElement.textContent || '{}') : {};
    const projectAssetElement = document.getElementById('project-asset-data');
    const projectAssetData = projectAssetElement ? JSON.parse(projectAssetElement.textContent || '{}') : {};
    const sequenceDataElement = document.getElementById('sequence-shot-data');
    const sequenceShotData = sequenceDataElement ? JSON.parse(sequenceDataElement.textContent || '{}') : {};

    const projectFilterSelect = document.getElementById('filter_project');
    const sequenceFilterSelect = document.getElementById('filter_sequence');
    const shotFilterSelect = document.getElementById('filter_shot');
    const assetFilterSelect = document.getElementById('filter_asset');
    const contextSelect = document.getElementById('filter_context');
    const filterForm = document.getElementById('task-filter-form');
    const assetFilterGroup = document.querySelector('.asset-filter-group');
    const sequenceFilterGroup = document.querySelector('.sequence-filter-group');
    const shotFilterGroup = document.querySelector('.shot-filter-group');

    const submitFilters = () => {
      if (!filterForm) return;
      syncOpenInputs();
      if (typeof filterForm.requestSubmit === 'function') {
        filterForm.requestSubmit();
      } else {
        filterForm.submit();
      }
    };

    const isAssetContext = () => contextSelect && contextSelect.value === 'asset';

    const resetFilterSelect = (select, placeholder) => {
      if (!select) return;
      select.innerHTML = '';
      const option = document.createElement('option');
      option.value = '';
      option.textContent = placeholder;
      select.appendChild(option);
    };

    const populateSequenceFilter = (projectId, selectedSequence) => {
      if (!sequenceFilterSelect) return;
      resetFilterSelect(sequenceFilterSelect, '----');
      const key = projectId ? String(projectId) : '';
      if (!key) {
        sequenceFilterSelect.disabled = true;
        sequenceFilterSelect.value = '';
        return;
      }
      const sequences = projectSequenceData[key] || [];
      sequences.forEach(seq => {
        const option = document.createElement('option');
        option.value = String(seq.id);
        option.textContent = seq.name;
        sequenceFilterSelect.appendChild(option);
      });
      sequenceFilterSelect.disabled = sequences.length === 0;
      if (!sequenceFilterSelect.disabled && selectedSequence) {
        sequenceFilterSelect.value = String(selectedSequence);
        if (sequenceFilterSelect.value !== String(selectedSequence)) {
          sequenceFilterSelect.value = '';
        }
      }
      if (sequenceFilterSelect.disabled) {
        sequenceFilterSelect.value = '';
      }
    };

    const populateShotFilter = (sequenceId, selectedShot) => {
      if (!shotFilterSelect) return;
      resetFilterSelect(shotFilterSelect, '----');
      const key = sequenceId ? String(sequenceId) : '';
      if (!key) {
        shotFilterSelect.disabled = true;
        shotFilterSelect.value = '';
        return;
      }
      const shots = sequenceShotData[key] || [];
      shots.forEach(shot => {
        const option = document.createElement('option');
        option.value = String(shot.id);
        option.textContent = shot.name;
        shotFilterSelect.appendChild(option);
      });
      shotFilterSelect.disabled = shots.length === 0;
      if (!shotFilterSelect.disabled && selectedShot) {
        shotFilterSelect.value = String(selectedShot);
        if (shotFilterSelect.value !== String(selectedShot)) {
          shotFilterSelect.value = '';
        }
      }
      if (shotFilterSelect.disabled) {
        shotFilterSelect.value = '';
      }
    };

    const populateAssetFilter = (projectId, selectedAsset) => {
      if (!assetFilterSelect) return;
      resetFilterSelect(assetFilterSelect, '----');
      const key = projectId ? String(projectId) : '';
      if (!key) {
        assetFilterSelect.disabled = true;
        assetFilterSelect.value = '';
        return;
      }
      const assets = projectAssetData[key] || [];
      assets.forEach(asset => {
        const option = document.createElement('option');
        option.value = String(asset.id);
        option.textContent = asset.name;
        assetFilterSelect.appendChild(option);
      });
      assetFilterSelect.disabled = assets.length === 0;
      if (!assetFilterSelect.disabled && selectedAsset) {
        assetFilterSelect.value = String(selectedAsset);
        if (assetFilterSelect.value !== String(selectedAsset)) {
          assetFilterSelect.value = '';
        }
      }
      if (assetFilterSelect.disabled) {
        assetFilterSelect.value = '';
      }
    };

    const applyContextState = () => {
      const assetMode = isAssetContext();
      if (assetFilterGroup) {
        assetFilterGroup.style.display = assetMode ? '' : 'none';
      }
      if (sequenceFilterGroup) {
        sequenceFilterGroup.style.display = assetMode ? 'none' : '';
      }
      if (shotFilterGroup) {
        shotFilterGroup.style.display = assetMode ? 'none' : '';
      }
      if (assetFilterSelect) {
        if (!assetMode) {
          assetFilterSelect.value = '';
          assetFilterSelect.disabled = true;
          assetFilterSelect.dataset.selected = '';
        } else if (!(projectFilterSelect && projectFilterSelect.value)) {
          assetFilterSelect.disabled = true;
        } else {
          assetFilterSelect.disabled = assetFilterSelect.options.length <= 1;
        }
      }
      if (sequenceFilterSelect) {
        if (assetMode) {
          sequenceFilterSelect.value = '';
          sequenceFilterSelect.disabled = true;
          sequenceFilterSelect.dataset.selected = '';
        } else if (projectFilterSelect && projectFilterSelect.value) {
          sequenceFilterSelect.disabled = sequenceFilterSelect.options.length <= 1;
        } else {
          sequenceFilterSelect.disabled = true;
        }
      }
      if (shotFilterSelect) {
        if (assetMode) {
          shotFilterSelect.value = '';
          shotFilterSelect.disabled = true;
          shotFilterSelect.dataset.selected = '';
        } else {
          const hasSequence = sequenceFilterSelect && sequenceFilterSelect.value;
          shotFilterSelect.disabled = !hasSequence || shotFilterSelect.options.length <= 1;
        }
      }
    };

    const initialProjectValue = projectFilterSelect ? projectFilterSelect.value : '';
    const initialSequenceValue = sequenceFilterSelect ? sequenceFilterSelect.dataset.selected : '';
    const initialShotValue = shotFilterSelect ? shotFilterSelect.dataset.selected : '';
    const initialAssetValue = assetFilterSelect ? assetFilterSelect.dataset.selected : '';

    if (contextSelect && contextSelect.value === 'asset') {
      populateAssetFilter(initialProjectValue, initialAssetValue);
    } else {
      populateSequenceFilter(initialProjectValue, initialSequenceValue);
      const effectiveSequence = sequenceFilterSelect ? sequenceFilterSelect.value : initialSequenceValue;
      populateShotFilter(effectiveSequence, initialShotValue);
    }
    applyContextState();

    if (projectFilterSelect) {
      projectFilterSelect.addEventListener('change', () => {
        if (isAssetContext()) {
          populateAssetFilter(projectFilterSelect.value, '');
          if (sequenceFilterSelect) {
            resetFilterSelect(sequenceFilterSelect, '----');
            sequenceFilterSelect.disabled = true;
            sequenceFilterSelect.value = '';
            sequenceFilterSelect.dataset.selected = '';
          }
          if (shotFilterSelect) {
            resetFilterSelect(shotFilterSelect, '----');
            shotFilterSelect.disabled = true;
            shotFilterSelect.value = '';
            shotFilterSelect.dataset.selected = '';
          }
        } else {
          populateSequenceFilter(projectFilterSelect.value, '');
          populateShotFilter('', '');
          if (assetFilterSelect) {
            resetFilterSelect(assetFilterSelect, '----');
            assetFilterSelect.value = '';
            assetFilterSelect.disabled = true;
            assetFilterSelect.dataset.selected = '';
          }
        }
        applyContextState();
        submitFilters();
      });
    }

    if (contextSelect) {
      contextSelect.addEventListener('change', () => {
        if (isAssetContext()) {
          const previousAsset = assetFilterSelect ? assetFilterSelect.dataset.selected || '' : '';
          if (assetFilterSelect) {
            populateAssetFilter(projectFilterSelect ? projectFilterSelect.value : '', previousAsset);
          }
          if (sequenceFilterSelect) {
            resetFilterSelect(sequenceFilterSelect, '----');
            sequenceFilterSelect.disabled = true;
            sequenceFilterSelect.value = '';
            sequenceFilterSelect.dataset.selected = '';
          }
          if (shotFilterSelect) {
            resetFilterSelect(shotFilterSelect, '----');
            shotFilterSelect.disabled = true;
            shotFilterSelect.value = '';
            shotFilterSelect.dataset.selected = '';
          }
        } else {
          const currentSequence = sequenceFilterSelect ? sequenceFilterSelect.value : '';
          const currentShot = shotFilterSelect ? shotFilterSelect.value : '';
          populateSequenceFilter(projectFilterSelect ? projectFilterSelect.value : '', currentSequence);
          const effectiveSequence = sequenceFilterSelect ? sequenceFilterSelect.value : currentSequence;
          populateShotFilter(effectiveSequence, currentShot);
          if (assetFilterSelect) {
            resetFilterSelect(assetFilterSelect, '----');
            assetFilterSelect.value = '';
            assetFilterSelect.disabled = true;
            assetFilterSelect.dataset.selected = '';
          }
        }
        applyContextState();
        submitFilters();
      });
    }

    if (sequenceFilterSelect) {
      sequenceFilterSelect.addEventListener('change', () => {
        if (isAssetContext()) {
          return;
        }
        populateShotFilter(sequenceFilterSelect.value, '');
        sequenceFilterSelect.dataset.selected = sequenceFilterSelect.value || '';
        applyContextState();
        submitFilters();
      });
    }

    if (shotFilterSelect) {
      shotFilterSelect.addEventListener('change', () => {
        if (isAssetContext()) {
          return;
        }
        shotFilterSelect.dataset.selected = shotFilterSelect.value || '';
        submitFilters();
      });
    }

    if (assetFilterSelect) {
      assetFilterSelect.addEventListener('change', () => {
        if (!isAssetContext()) {
          return;
        }
        assetFilterSelect.dataset.selected = assetFilterSelect.value || '';
        submitFilters();
      });
    }

    const assignSelect = document.getElementById('assign_type');
    const assetField = document.querySelector('.asset-field');
    const assetSelect = document.getElementById('id_asset');
    const sequenceField = document.querySelector('.sequence-field');
    const sequenceSelect = document.getElementById('id_sequence');
    const shotField = document.querySelector('.shot-field');
    const shotSelect = document.getElementById('id_shot');
    const taskNameField = document.querySelector('.task-name-field');
    const taskNameInput = taskNameField ? taskNameField.querySelector('input, textarea, select') : null;

    const resetShotOptions = () => {
      if (!shotSelect) return;
      shotSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '-- Select Shot --';
      shotSelect.appendChild(placeholder);
    };

    const populateShots = (sequenceId, selectedShot) => {
      if (!shotSelect) return;
      resetShotOptions();
      if (!sequenceId) return;
      const shots = sequenceShotData[String(sequenceId)] || [];
      shots.forEach(shot => {
        const option = document.createElement('option');
        option.value = String(shot.id);
        option.textContent = shot.name;
        shotSelect.appendChild(option);
      });
      if (selectedShot) {
        shotSelect.value = String(selectedShot);
      }
    };

    const syncAssignmentVisibility = (selectedShot) => {
      if (!assignSelect) return;
      const value = assignSelect.value;

      if (value === 'asset') {
        if (assetField) assetField.style.display = 'block';
        if (assetSelect) {
          assetSelect.disabled = false;
        }
        if (taskNameField) taskNameField.style.display = 'none';
        if (taskNameInput) {
          taskNameInput.value = '';
          taskNameInput.disabled = true;
        }
        if (sequenceField) sequenceField.style.display = 'none';
        if (shotField) shotField.style.display = 'none';
        if (sequenceSelect) {
          sequenceSelect.value = '';
          sequenceSelect.disabled = true;
        }
        if (shotSelect) {
          resetShotOptions();
          shotSelect.disabled = true;
        }
      } else if (value === 'shot') {
        if (assetField) assetField.style.display = 'none';
        if (assetSelect) {
          assetSelect.value = '';
          assetSelect.disabled = true;
        }
        if (taskNameField) taskNameField.style.display = 'block';
        if (taskNameInput) {
          taskNameInput.disabled = false;
        }
        if (sequenceField) sequenceField.style.display = 'block';
        if (shotField) shotField.style.display = 'block';
        if (sequenceSelect) {
          sequenceSelect.disabled = false;
        }
        if (sequenceSelect && sequenceSelect.value) {
          populateShots(sequenceSelect.value, selectedShot);
          if (shotSelect) {
            shotSelect.disabled = false;
          }
        } else {
          resetShotOptions();
          if (shotSelect) {
            shotSelect.disabled = true;
          }
        }
      } else {
        if (assetField) assetField.style.display = 'none';
        if (assetSelect) {
          assetSelect.value = '';
          assetSelect.disabled = false;
        }
        if (taskNameField) taskNameField.style.display = 'none';
        if (taskNameInput) {
          taskNameInput.value = '';
          taskNameInput.disabled = true;
        }
        if (sequenceField) sequenceField.style.display = 'none';
        if (shotField) shotField.style.display = 'none';
        if (sequenceSelect) {
          sequenceSelect.value = '';
          sequenceSelect.disabled = true;
        }
        if (shotSelect) {
          resetShotOptions();
          shotSelect.disabled = true;
        }
      }
    };

    const inferAssignType = () => {
      if (!assignSelect) return;
      if (assetSelect && assetSelect.value) {
        assignSelect.value = 'asset';
      } else if ((sequenceSelect && sequenceSelect.value) || (shotSelect && shotSelect.value)) {
        assignSelect.value = 'shot';
      } else {
        assignSelect.value = '';
      }
    };

    const initialSequence = sequenceSelect ? sequenceSelect.value : '';
    const initialShot = shotSelect ? shotSelect.value : '';
    if (initialSequence) {
      populateShots(initialSequence, initialShot);
    } else {
      resetShotOptions();
      if (shotSelect) {
        shotSelect.disabled = true;
      }
    }

    inferAssignType();
    syncAssignmentVisibility(initialShot);

    if (assignSelect) {
      assignSelect.addEventListener('change', () => {
        syncAssignmentVisibility(shotSelect ? shotSelect.value : '');
      });
    }

    if (sequenceSelect) {
      sequenceSelect.addEventListener('change', () => {
        populateShots(sequenceSelect.value, '');
        if (shotSelect) {
          shotSelect.disabled = !sequenceSelect.value;
        }
      });
    }

    const markRowDirty = (element) => {
      const row = element.closest('.task-row');
      if (!row) return;
      row.classList.remove('green');
      row.classList.add('orange');
    };

    document.querySelectorAll('.task-row select[name="status"], .task-row select[name="task_type"]').forEach(select => {
      select.addEventListener('change', () => markRowDirty(select));
    });

    document.querySelectorAll('.task-row input[name="task_name"]').forEach(input => {
      input.addEventListener('input', () => markRowDirty(input));
    });

    document.querySelectorAll('.task-row textarea[name="description"]').forEach(textarea => {
      textarea.addEventListener('input', () => markRowDirty(textarea));
    });

    syncOpenInputs();
  });
</script>
{% endblock %}




